const express = require("express");
const http = require("http");

const WebSocket = require('ws');
const wss = new WebSocket.Server({ port: 3000 });

// L∆∞u danh s√°ch client c√πng v·ªõi userId
const clients = new Map(); // Map<ws, userId>

wss.on('connection', (ws) => {
  console.log('‚úÖ New client connected');

  // Khi client g·ª≠i userId sau khi connect
  ws.on('message', (message) => {

    console.log('‚úÖ server receive message' + message.toString());

    try {
      const data = JSON.parse(message.toString());

      // 1Ô∏è‚É£ N·∫øu l√† message ƒëƒÉng k√Ω userId
        if (data.messageType === 'create_room') {
              data.users.forEach(u => {
              clients.set(u.userId, ws); // key = userId, value = socket
              console.log(`üì≤ Registered userId=${u.userId} (${u.userFullName})`);
      });
        console.log(`üì≤ Registered client with userId=${data.userId}`);
        return;
      }

      // 2Ô∏è‚É£ N·∫øu l√† message g·ª≠i d·ªØ li·ªáu b√¨nh th∆∞·ªùng
      if (data.messageType === 'SEND_MESSAGE') {
        const { userIds, content } = data;
        console.log(`üì© Message to users [${userIds.join(', ')}]: ${data}`);

        // G·ª≠i cho c√°c client c√≥ userId trong danh s√°ch
        clients.forEach((client, uid) => {
            console.log(`check condition uid : ${uid}`);
            if (userIds.includes(uid) && client.readyState === WebSocket.OPEN) {
              const messagePayload = {
              fromUserId: uid,
              content: content,
              timestamp: Date.now(),
            };

            client.send(JSON.stringify(messagePayload));
            console.log(`‚úÖ Sent message to userId=${uid}`);
            }
        });
      }

    } catch (err) {
      console.error('‚ùå Invalid message:', err);
    }
  });

  ws.on('close', () => {
    console.log('‚ùå Client disconnected');
    clients.delete(ws);
  });
});


